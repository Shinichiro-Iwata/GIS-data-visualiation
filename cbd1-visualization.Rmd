---
title: "小地域統計による人口変化の可視化"
subtitle: "小田原市の例"
author: "[岩田真一郎](https://shinichiro-iwata.github.io/)（[神奈川大学経済学部](https://www.econ.kanagawa-u.ac.jp/)）"
date: '`r Sys.Date()`'
output: 
  html_document:
    highlight: "pygments"
---

# 目的
2年分のデータを用いて国勢調査の小地域（町丁・字等別，ポリゴン）に人口変化及び人口変化率を示す．

ライブラリ：`sf`，`tidyverse`

```{r, warning=FALSE, message=FALSE}
library(sf)
library(tidyverse)
```

# 小地域の人口の可視化
**境界データのダウンロード**

- [地図で見る統計](https://www.e-stat.go.jp/gis)　>　境界データダウンロード　>　小地域　>　国勢調査　>　2020年（または2010年）　>　小地域（町丁・字等別）（JGD2000[^foot1]）　>　世界測地系緯度経度・Shapefile　>　14206 小田原市 

[^foot1]:座標参照系（`crs`）が`JGD2000`（2000年に定められた世界測地系に基づく日本測地系）．一方，[国土数値情報](https://nlftp.mlit.go.jp/index.html)で提供されているデータの多くは`JGD2011`（2011年に変更された日本測地系）．この座標参照系の違いのため，小田原市の地図上に小田原市に隣接する地域の行政区域や鉄道路線を重ねようとしたが，ずれてしまう．座標参照系を合わせる努力を様々試みたが，断念．解決できる大学生やゼミナール性は是非その方法を教えてほしい．

```{r}
#2020年
Odawara_shi_map20<-
  read_sf("A002005212020DDSWC14206/r2ka14206.shp")

#2010年 
Odawara_shi_map10<-
  read_sf("A002005212010DDSWC14206/h22ka14206.shp")
```

**統計データのダウンロード**

- [地図で見る統計](https://www.e-stat.go.jp/gis)　>　統計データダウンロード　>　小地域　>　国勢調査　>　2020年（または2010年）　>　小地域（町丁・字等別）　>　男女別人口総数及び世帯総数　>　14神奈川県
  - データはテキスト形式．`read.table`で読込．
    - `Kanagawa_pop#`と名付ける．
    - `header=TRUE`は列名が含まれていることを意味する．仮に列名がなければ`FALSE`．ダウンロードしたデータは2列にわたって列名がある．
    - `sep=","`はデータがカンマで区切られていることを意味する．`skip=1`は1番最初の行を削除することを意味する．後ほど，1行目にあった情報を再度加える． 

```{r}
#2020年
Kanagawa_pop20<-read.table("tblT001081C14/tblT001081C14.txt",
                  header=TRUE, sep=",", skip=1)

#列名の変更（1～4列目）
names(Kanagawa_pop20)[1]<-"KEY_CODE"
names(Kanagawa_pop20)[2]<-"HYOSYO"
names(Kanagawa_pop20)[3]<-"CITYNAME"	
names(Kanagawa_pop20)[4]<-"NAME"

#2010年
Kanagawa_pop10<-read.table("tblT000572C14/tblT000572C14.txt",
                           header=TRUE, sep=",", skip=1)

#列名の変更（1～4列目）
names(Kanagawa_pop10)[1]<-"KEY_CODE"
names(Kanagawa_pop10)[2]<-"HYOSYO"
names(Kanagawa_pop10)[3]<-"CITYNAME"	
names(Kanagawa_pop10)[4]<-"NAME"
``` 

- 便宜上，小田原市の人口総数だけを抜き出す（`filiter`）．`Odawara_shi_pop#`と名付ける．

```{r}
Kanagawa_pop20 %>%
  filter(CITYNAME=="小田原市") ->
  Odawara_shi_pop20

Kanagawa_pop10 %>%
  filter(CITYNAME=="小田原市") ->
  Odawara_shi_pop10
```

**人口総数**

小地域の人口は「人口総数」の列に含まれているが，文字情報．

- 数値（`numeric`）情報に変更（`mutate`）する．再び `Odawara_shi_pop_#`と名付ける．
  - 欠損値（データに「-」含まれる）は`NA`に強制変換（`Warning`（警告メッセージ）が出現するが問題ない）．

```{r warning=FALSE}
#2020年
Odawara_shi_pop20 %>%
  mutate(人口総数=as.numeric(人口総数)) ->
  Odawara_shi_pop20

#2010年
Odawara_shi_pop10 %>%
  mutate(人口総数=as.numeric(人口総数)) ->
  Odawara_shi_pop10
```

**データ結合1**

各年の境界データと統計データを結合．

- **注意**：境界データの`KEY_CODE`が`character`（文字データ），統計データは`integer`（数データ）のため結合できない．
  - そこで，統計データ（`Odawara_shi_pop_#`）の`KEY_CODE`を`character`に変換（`mutate`）する．再`Odawara_shi_pop_#`と名付ける．

- `KEY_CODE`で結合し，`Odawara_shi#`と名付ける．

```{r}
#文字データへの変換
Odawara_shi_pop20 %>%
  mutate(KEY_CODE=as.character(KEY_CODE)) ->
  Odawara_shi_pop20

Odawara_shi_pop10 %>%
  mutate(KEY_CODE=as.character(KEY_CODE)) ->
  Odawara_shi_pop10

#データの結合
Odawara_shi20<-
  left_join(Odawara_shi_map20, Odawara_shi_pop20, 
          by=c("KEY_CODE")) 

Odawara_shi10<-
  left_join(Odawara_shi_map10, Odawara_shi_pop10, 
          by=c("KEY_CODE"))
```

**人口分布の可視化**

境界データにも小地域の人口（`JINKO`）が含まれている．したがって，人口だけを見るのであれば，統計データを結合する必要ないが，統計データの「人口総数」と値が異なる小地域が存在．

- 下の図で確認．例えば黄色の枠の箇所．境界データではこの箇所は`0`．

```{r, echo=FALSE, warning=FALSE, message=FALSE}
Odawara_shi_map10 %>%
  filter(S_NAME=="飯田岡") %>%
  filter(KIGO_E=="E2") ->
  Iidaoka

fig1<-
  ggplot()+
  geom_sf(data=Odawara_shi_map10, aes(fill=JINKO))+
  scale_fill_viridis_c(option="G", direction=-1)+
  geom_sf(data=Iidaoka, fill="NA", color="yellow")+
  labs(fill="人")+
  ggtitle("2010年JINKO")+
  coord_sf(datum=NA)+
  theme_bw()+
  theme(legend.position="bottom",
        text=element_text(size=6),
        legend.key.size=unit(0.5, "cm"))

fig2<-
  ggplot()+
  geom_sf(data=Odawara_shi10, aes(fill=人口総数))+
  scale_fill_viridis_c(option="G", direction=-1)+
  geom_sf(data=Iidaoka, fill="NA", color="yellow")+
  labs(fill="人")+
  ggtitle("2010年人口総数")+
  coord_sf(datum=NA)+
  theme_bw()+
  theme(legend.position="bottom",
        text=element_text(size=6),
        legend.key.size=unit(0.5, "cm"))

fig3<-
  ggplot()+
  geom_sf(data=Odawara_shi_map20, aes(fill=JINKO))+
  scale_fill_viridis_c(option="G", direction=-1)+
  geom_sf(data=Iidaoka, fill="NA", color="yellow")+
  labs(fill="人")+
  ggtitle("2020年JINKO")+
  coord_sf(datum=NA)+
  theme_bw()+
  theme(legend.position="bottom",
        text=element_text(size=6),
        legend.key.size=unit(0.5, "cm"))

fig4<-
  ggplot()+
  geom_sf(data=Odawara_shi20, aes(fill=人口総数))+
  scale_fill_viridis_c(option="G", direction=-1)+
  geom_sf(data=Iidaoka, fill="NA", color="yellow")+
  labs(fill="人")+
  ggtitle("2020年人口総数")+
  coord_sf(datum=NA)+
  theme_bw()+
  theme(legend.position="bottom",
        text=element_text(size=6),
        legend.key.size=unit(0.5, "cm"))

library(patchwork) #図を並べるため
fig1+fig2+fig3+fig4+
  plot_layout(ncol=2) #1行2枚
```

# 統計データによる人口変化の可視化 
統計データを用いて人口変化（増減）と人口変化（増減）率を計算．

**データ結合2**

2010年と2020年のデータを横方向に結合．

- `cbind()`：データを横方向に結合．右側（`Odawara_shi20`）のデータの列名はすべて「～.1」に自動変更．

```{r}
Odawara_shi<-
  cbind(Odawara_shi10, Odawara_shi20)
```

**人口変化と人口変化率**

- 2020年の人口総数（人口総数.1）から2010年の人口総数（人口総数）を引き，人口変化をとらえる．計算された列を`diff_pop`と名付ける．
- 変化率の計算式は（2020年人口ー2010年の人口）／2010年の人口）×100）の通り．計算された列を`pop_rate`と名付ける．

```{r}
#人口変化
Odawara_shi %>%
  mutate(diff_pop=人口総数.1-人口総数) ->
  Odawara_shi

#人口変化率
Odawara_shi %>%
  mutate(pop_rate=(人口総数.1-人口総数)/人口総数*100) ->
  Odawara_shi
```

**完成図形**

完成図形の可視化．

- `scale_color_gradient2()`：中間値（初期値は`0`）より大きな値と小さな値で色を塗り分けることを可能にする関数．
  - ここでは，変化（率）`0`を白，負を青，正を赤に設定．ただし，`muted()`は色を落ち着かせる際に利用．`muted()`利用のため，`scales`パッケージを呼び出す（`library`)．
  - `muted()`は指示しなくても問題ない．その場合は単に`low=blue`と指示．利用しない場合は`scales`パッケージを呼び出す必要もない．

```{r, message=FALSE}
#muted()利用
library(scales) 

#人口変化の可視化
ggplot()+
  geom_sf(data=Odawara_shi, aes(fill=diff_pop))+
  scale_fill_gradient2(low=muted("blue"), 
                       mid="white", 
                       high=muted("red"))+
  labs(fill="人")+
  ggtitle("人口変化（2010年ー2020年）")+
  theme_bw() 
```

```{r}
#人口変化率の可視化
ggplot()+
  geom_sf(data=Odawara_shi, aes(fill=pop_rate))+
  scale_fill_gradient2(low=muted("blue"), 
                       mid="white", 
                       high=muted("red"))+
  labs(fill="％")+
  ggtitle("人口変化率（2010年ー2020年）")+
  theme_bw() 
```

**Rによる地理空間データの可視化**

- チュートリアル[ホーム](https://shinichiro-iwata.github.io/geospatial-data-visualization/)