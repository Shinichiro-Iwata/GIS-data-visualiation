---
title: "空間内挿による地価の可視化"
subtitle: "富山市の例"
author: "[岩田真一郎](https://shinichiro-iwata.github.io/)（[神奈川大学経済学部](https://www.econ.kanagawa-u.ac.jp/)）"
date: "2022-06-23作成，`r Sys.Date()`改訂"
output: 
  html_document:
    highlight: "pygments"
---
# 目的
[ポイントデータによる地価の可視化](https://shinichiro-iwata.github.io/geospatial-data-visualization/point-data-visualization.html)では，地価公示を利用して調査地点（観測ポイント）の土地価格を可視化した．この情報を利用して，調査地点以外の箇所の地価を予測し，地域全体にわたる地価の様子を表現する．

- 調査地点ではない箇所（予測地点）の地価は，調査地点の地価と空間的に相関すると考えて予測する．この作業を空間[内挿](https://www.esrij.com/gis-guide/spatial/interpolation/)（空間[補間](https://gis-oer.github.io/gitbook/book/materials/18/18.html)）という．
  - ここでは地域全体を覆うメッシュ（グリッド）を作成し，そのメッシュにデータを埋める作業を行う．
  - 空間内挿手法の一つである逆距離加重法（IDW：inverse distance weighting）を利用．予測地点の地価は予測地点と調査地点の距離に依存し，距離が遠くなるほど影響力が小さくなると仮定（距離の逆数の重み付け）．

- 富山市の経年変化を可視化．
  - 時代背景は[立地適正化計画区域内の地価の可視化](https://shinichiro-iwata.github.io/geospatial-data-visualization/compactcity-network-visualization.html)を参照．

ライブラリ：`sf`，`tidyverse`，`gstat`
```{r, warning=FALSE, message=FALSE}
library(sf)
library(tidyverse)

#idw()利用のため
library(gstat)
```

# 地価の可視化
**シェープファイルのダウンロード**

- [国土数値情報ダウンロードサービス](https://nlftp.mlit.go.jp/ksj/)　>　行政区域（ポリゴン）　>　富山県　>　令和3年

- [国土数値情報ダウンロードサービス](https://nlftp.mlit.go.jp/ksj/)　>　地価公示（ポイント）　>　富山県　>　「富山県」データのダウンロード　>　世界測地系　令和4年

   - ダウンロードしたZIPファイルは同じフォルダー（ディレクトリ）に納め，ZIPファイルを選択 >　右クリック　>　すべて展開　>　展開先の選択とファイルの選択　>　展開を実行する．展開後は最初にダウンロードしたZIPファイルを削除．
   - `read_sf()`：データ読込．
　 - `crs="JGD2011"`を指定．crs（Coordinate ReferenceSystem，座標参照系）を2011年に定められた世界測地系に基づく日本測地系（Japanese Geodetic Datum）に投影を意味．この指定がないとうまく行かなかった．
　 - パイプ演算子（`%>%`）を使い，富山県のデータから富山市のデータを抜き出し．

```{r}
#富山県の地図
Toyama_map<-
  read_sf("N03-20210101_16_GML/N03-20210101_16_GML/N03-21_16_210101.shp",  
          crs="JGD2011")

#富山市の選別
Toyama_map %>%
  filter(N03_004=="富山市") -> 
  Toyama_shi_map

#富山県の地価の地図
Toyama_lp<-
  read_sf('L01-22_16_GML/L01-22_16.shp', 
          crs="JGD2011")

#富山市の地価の選別
Toyama_lp %>%
  filter(L01_022=="16201") -> 
  Toyama_shi_lp 
```

**各年地価**

- 2022年には観測されたが，1997年と2007年当時は観測されていなかったポイントは，地価が`0`になっている．実際には地価が`0`円ということではないため削除．
 - 地価の単位は円／㎡．→　万円／㎡にする．
 - `scale_color_viridis_c()`:連続変数の色分けを指示．`viridis`で用意されているカラーマップは`A`から`H`の8種類用意されている．
```{r}
#1997年（地価はL01_075の列）
#ゼロを削除
Toyama_shi_lp75<- 
  Toyama_shi_lp[!(Toyama_shi_lp$L01_075=="0"),] 

#単位変換
Toyama_shi_lp75 %>% 
  mutate(L01_075=L01_075/10000) -> 
  Toyama_shi_lp75

#順番の変更
Toyama_shi_lp75 %>%
  arrange(L01_075) -> 
  Toyama_shi_lp75

#1997年の地価分布の可視化
ggplot()+
  geom_sf(data=Toyama_shi_map, fill="white")+
  geom_sf(data=Toyama_shi_lp75, aes(color=L01_075))+
  scale_color_viridis_c(option="G", direction=-1)+
  labs(color="万円／㎡")+
  ggtitle("富山市の地価（1997年）")+
  theme_bw()
```

- 同様に2007年の地価も整理．地図の可視化は省略．
  
```{r}
#2007年（地価はL01_085の列）
#ゼロを削除
Toyama_shi_lp85<- 
  Toyama_shi_lp[!(Toyama_shi_lp$L01_085=="0"),] 

#単位変換
Toyama_shi_lp85 %>% 
  mutate(L01_085=L01_085/10000) -> 
  Toyama_shi_lp85
```

- 2022年の地価整理．地図の可視化は省略．
  - 2022年の地価公示データのため，2022年の調査地点の地価はすべて記載．

```{r}
#単位変換
Toyama_shi_lp %>% 
  mutate(L01_006=L01_006/10000) -> 
  Toyama_shi_lp6
```

# メッシュ（グリッド）の作成

- `st_make_grid()`：富山市の地図（`Toyama_shi_map`）に合わせてメッシュ（`grid`）の作成の指示．
  - `n=c(#, #)`：メッシュの数を指定．x軸方向の数とy軸方向の数の順番．ここでは，それぞれ`100`としているため，100×100で1000のメッシュを作成．
  - 数を小さくすると，メッシュは大きくなり（荒い），数を大きくすると，メッシュは小さくなる（細かい）．
  - [gstat | 空间插值（一）](https://www.i4k.xyz/article/weixin_54000907/116725963)（アクセス日：2022/06/23）を参考に作成．中国語だが，漢字を頼りに解読．コードは読める．空间插值＝空間補間．

- 後ほど，このメッシュ内にデータを内挿．このとき，メッシュ数が多いほど（例えば，1000×1000），データ量が増えるため，**地図作成時間が長くなる**ことに注意．

```{r}
#メッシュ（グリッド）作成
Toyama_shi_grid<-
  st_make_grid(Toyama_shi_map, n=c(100, 100))

#メッシュの可視化
ggplot()+
  geom_sf(data=Toyama_shi_grid)+
  geom_sf(data=Toyama_shi_map, fill="NA")+
  ggtitle("作成したメッシュ")+
  theme_bw()
```

# 逆距離加重法（IDW）

- `idw()`：逆距離加重法による空間内挿の適用．
  - `L01_075~1`：1997年の地価の内挿を行う際の関数系．`1`は線形．
  - `Toyama_shi_lp85`：調査地点（観測ポイント）が含まれるデータを指定．
  - `Toyama_shi_grid`：内挿を行うメッシュを指示．
  - `idp`：予測地点と調査地点の距離にかかる累乗の指定．ここでは`2`を選択．
  - Brunsdon & Comberx（2018）参照．

```{r eval=FALSE}
#1997年の空間内挿
Toyama_shi_idw75<-
  idw(L01_075~1, Toyama_shi_lp75, Toyama_shi_grid, idp=2)

#2007年の空間内挿
Toyama_shi_idw85<-
  idw(L01_085~1, Toyama_shi_lp85, Toyama_shi_grid, idp=2)

#2022年の空間内挿
Toyama_shi_idw6<-
  idw(L01_006~1, Toyama_shi_lp6, Toyama_shi_grid, idp=2)
```

**注意**

- 利用するパソコンの性能に依存するが，空間内挿はメッシュの数が多いと時間がかかる．作成したデータを何度も使用する場合，毎回上記のデータを作成することは時間の浪費．
  - データを保存（`save`）して，使用する際に読込（`load`）．
  - 同じフォルダーに保存する際のコード．`Toyama_shi_idw75`を`Toyama_shi_idw75.Rdata`と名付けて保存．
  
```{r eval=FALSE}
#データの保存
save(Toyama_shi_idw75, file="Toyama_shi_idw75.Rdata")
save(Toyama_shi_idw85, file="Toyama_shi_idw85.Rdata")
save(Toyama_shi_idw6, file="Toyama_shi_idw6.Rdata")
```

```{r}
#データの読込
load("Toyama_shi_idw75.Rdata")
load("Toyama_shi_idw85.Rdata")
load("Toyama_shi_idw6.Rdata")
```

# 空間内挿による可視化
**データ結合**

空間内挿によって作成した図を富山市の地図に重ねてみる.

- 各メッシュにデータが新たに内挿．`var1.pred`の列に含まれる．
  - メッシュ（`Toyama_shi_grid`）は富山市の行政区域（`Toyama_shi_map`）からはみ出しているため，はみ出さないように，`Toyama_shi_grid`と`Toyama_shi_map`を結合する．`st_intersection()`を用いて共通部分を切り取る．
    - 属性がジオメトリ全体で空間的に一定と仮定しないと警告が出る？？？．一定（`constant`）と指定．

```{r}
st_agr(Toyama_shi_map)="constant"
st_agr(Toyama_shi_idw75)="constant"
st_agr(Toyama_shi_idw85)="constant"
st_agr(Toyama_shi_idw6)="constant"

#データの結合
Toyama_intersec75<-
  st_intersection(Toyama_shi_idw75, Toyama_shi_map)
Toyama_intersec85<-
  st_intersection(Toyama_shi_idw85, Toyama_shi_map)
Toyama_intersec6<-
  st_intersection(Toyama_shi_idw6, Toyama_shi_map)
```

**1997年の地価の可視化**

　- 調査地点（`Toyama_shi_lp`）も参考に示す．ポイントの形状（`shape`）を枠を黒，枠内を透明（`21`）にサイズ（`size`）を小さくする．
　  - その他の形状：[shape](https://ggplot2.tidyverse.org/articles/ggplot2-specs.html#sec:shape-spec)参照．

```{r}
ggplot()+
  geom_sf(data=Toyama_intersec75, aes(fill=var1.pred))+
  scale_fill_viridis_c(option="G", direction=-1)+
  geom_sf(data=Toyama_shi_lp, shape=21, size=0.5)+
  coord_sf(xlim= c(136.96, 137.4), ylim=c(36.5, 36.78))+
  labs(fill="万円／㎡")+
  ggtitle("調査地点と空間内挿による富山市の地価（1997年）")+
  theme_bw()
```

## 完成図
**CRSの変更**

概ね，上記の地図により空間内挿による地価分布を示せた．ここからは，地図上に鉄道を示したり，`CRS`を変更したりする．

- 今回は空間内挿のために`CRS`を`JGD2011`に指示．これを，`WGS84`に変更する．

```{r}
proj<-
  "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"

st_crs(Toyama_intersec75)=proj
st_crs(Toyama_intersec85)=proj
st_crs(Toyama_intersec6)=proj
```

**行政区域の地図**

富山県と富山市の行政区域の地図を改めてオプション（`crs="JSD2011"`）なしで読み込み．別名を付ける（それぞれ，`Toyama_map1`と`Toyama_shi_map1`と名付ける）．

```{r}
#富山県の地図（オプションなし）
Toyama_map1<-
  read_sf("N03-20210101_16_GML/N03-20210101_16_GML/N03-21_16_210101.shp")

#富山市の選別
Toyama_map1 %>%
  filter(N03_004=="富山市") -> 
  Toyama_shi_map1
```

地図上に鉄道（ライン）を示すため，シェープファイルをダウンロード．

- [国土数値情報ダウンロードサービス](https://nlftp.mlit.go.jp/ksj/)　>　鉄道（ライン）　>　全国　>　世界測地系 >　平成19年（および令和2年）　
  
  - 鉄道データは全国のみ．
  - 2007年（平成19年）は`crs="WGS84"`が必要．`railway07`と名付ける．
  - 1997年（平成9年）はデータが掲載されていない
  - 2000年（令和2年）は`railway20`と名付ける．
  　　- パイプ演算子（`%>%`）を使い，路線名（鉄道路線の名称，`N02_003`）の「北陸新幹線」を抜き出し`Hokuriku_shinkansen`と名付ける．

```{r}
#2007年の鉄道路線図
railway07<-
  read_sf("N02-07_GML/N02-07-g_RailroadSection.shp",
                   crs="WGS84")

#2020年の鉄道路線図
railway20<-
  read_sf("N02-20_GML/N02-20_GML/N02-20_RailroadSection.shp")

#新幹線の選別
railway20 %>%
  filter(N02_003=="北陸新幹線")->
  Hokuriku_shinkansen
```

**完成図**

- メッシュの枠は消す（`color=NA`）．
- 1997年のコードのみ表記．
  - 地価の水準（凡例）が異なることに注意．

```{r}
#1997年の完成図
ggplot()+
  geom_sf(data=Toyama_map1)+
  geom_sf(data=Toyama_intersec75, 
          aes(fill=var1.pred), color=NA)+
  scale_fill_viridis_c(option="G", direction=-1)+
  geom_sf(data=Toyama_shi_map1, fill="NA", size=0.8)+
  geom_sf(data=railway07, size=0.2, 
          linetype="dashed")+
  labs(fill="万円／㎡")+
  ggtitle("富山市の地価（1997年）")+
  coord_sf(xlim= c(136.96, 137.4), ylim=c(36.5, 36.78))+
  theme_bw()
```

```{r echo=FALSE}
#2007年の完成図
ggplot()+
  geom_sf(data=Toyama_map1)+
  geom_sf(data=Toyama_intersec85, 
          aes(fill=var1.pred), color=NA)+
  scale_fill_viridis_c(option="G", direction=-1)+
  geom_sf(data=Toyama_shi_map1, fill="NA", size=0.8)+
  geom_sf(data=railway07, size=0.2, 
          linetype="dashed")+
  labs(fill="万円／㎡")+
  ggtitle("富山市の地価（2007年）")+
  coord_sf(xlim= c(136.96, 137.4), ylim=c(36.5, 36.78))+
  theme_bw()
  
#2022年の完成図
  ggplot()+
  geom_sf(data=Toyama_map1)+
  geom_sf(data=Toyama_intersec6, 
          aes(fill=var1.pred), color=NA)+
  scale_fill_viridis_c(option="G", direction=-1)+
  geom_sf(data=Toyama_shi_map1, fill="NA", size=0.8)+
  geom_sf(data=railway20, size=0.2, 
          linetype="dashed")+
  geom_sf(data=Hokuriku_shinkansen, size=0.55, 
          linetype="f8")+
  geom_text(aes(x=137.39, y=36.75), size=3, 
              label="北陸新幹線")+
  labs(fill="万円／㎡", x="", y="")+
  ggtitle("富山市の地価（2022年）")+
  coord_sf(xlim= c(136.96, 137.4), ylim=c(36.5, 36.78))+
  theme_bw()
```

# 補論

**複数地図の比較**

比較しやすいように3枚の地図を並べる．複数の地図を同時に可視化．

- コードは示さない．

```{r echo=FALSE}
#1997年の完成図
map75<-
  ggplot()+
  geom_sf(data=Toyama_intersec75, 
          aes(fill=var1.pred), color=NA)+
  scale_fill_viridis_c(option="G", direction=-1)+
  labs(fill="万円／㎡（97年）")+
  coord_sf(xlim= c(136.96, 137.4), ylim=c(36.5, 36.78),
           datum=NA)+
  theme_bw()+
  theme(legend.position="bottom",
        text=element_text(size=6),
        legend.key.size=unit(0.5, "cm"))

map85<-
  ggplot()+
  geom_sf(data=Toyama_intersec85, 
          aes(fill=var1.pred), color=NA)+
  scale_fill_viridis_c(option="G", direction=-1)+
  labs(fill="万円／㎡（07年）")+
  coord_sf(xlim= c(136.96, 137.4), ylim=c(36.5, 36.78),
           datum=NA)+
  theme_bw()+
  theme(legend.position="bottom",
        text=element_text(size=6),
        legend.key.size=unit(0.5, "cm"))

map6<-
  ggplot()+
  geom_sf(data=Toyama_intersec6, 
          aes(fill=var1.pred), color=NA)+
  scale_fill_viridis_c(option="G", direction=-1)+
  labs(fill="万円／㎡（22年）")+
  coord_sf(xlim= c(136.96, 137.4), ylim=c(36.5, 36.78),
           datum=NA)+
  theme_bw()+
  theme(legend.position="bottom",
        text=element_text(size=6),
        legend.key.size=unit(0.5, "cm"))

library(patchwork) #図を並べるため
map75+map85+map6+
  plot_layout(ncol=2) #1行2枚
```

**データの結合**

- 上の3枚の地図の違いは注意深く見ないと分からない（間違い探しクイズの模様）．
  - 凡例を見ると，地価水準に大きな違い．
  - そこで，別々のデータおよび凡例を一つにまとめる．
  - データは縦方向に結合．識別は年（`year`）による．

- その他の点として，物価水準の違いを調整．

  - [e-Stat](https://www.e-stat.go.jp/)　>　キーワード検索 ：消費者物価指数（「検索」クリック）　>　2015年基準消費者物価指数　>　5011件　>　 長期時系列データ　>　都市階級・地方・大都市圏・都道府県庁所在市別中分類指数　>　富山市
  - 「A00136」シートにあるの「001 0001：総合」を利用．3年分だけのため，その値をみると，97年が`99.9`, 07年が`97.6`, 22年（2015年版には掲載なし，21年）`102.3`．
  - それぞれ100で割り，その値で各年の予測値を割る．物価調整済みの予測値を`pred`と名付ける．

```{r}
#物価調整
Toyama_intersec75 %>%
  mutate(pred=var1.pred/0.999) ->
  Toyama_intersec75

Toyama_intersec85 %>%
  mutate(pred=var1.pred/0.976) ->
  Toyama_intersec85

Toyama_intersec6 %>%
  mutate(pred=var1.pred/1.023) ->
  Toyama_intersec6

#識別する列（year）の作成（各データ：4940行）
Toyama_intersec75$year<-c(rep(1997,4940))
Toyama_intersec85$year<-c(rep(2007,4940))
Toyama_intersec6$year<-c(rep(2022,4940))

#データの結合
Toyama_7585<-rbind(Toyama_intersec75, Toyama_intersec85)
Toyama_75856<-rbind(Toyama_7585, Toyama_intersec6)
```

**凡例を一つにまとめた図**

1997年の地価は2007年，2022年の地価より高いことを確認． 

- `datum=NA`：緯度経度の表記なし
- `facet_wrap()`：複数の地図の並べ方を指示．
  - `~year`：年ごとに地図を作成．．
  - `ncol=2`：1行に地図を2枚並列．
```{r}
ggplot()+geom_sf(data=Toyama_75856,
                 aes(fill=pred), color=NA)+
  scale_fill_viridis_c(option="G", direction=-1)+
  coord_sf(xlim=c(136.96, 137.4), ylim=c(36.5, 36.78),
           datum=NA)+
  facet_wrap(~year, ncol=2)+
  labs(fill="万円／㎡")+
  theme_bw()
```

**参考文献**

- Brunsdon，C. & Comber, L. （訳：湯谷啓明・工藤和奏・市川太祐）（2018）. 『[Rによる地理空間データ解析入門](https://www.kyoritsu-pub.co.jp/book/b10003125.html)』「共立出版」．
- キーラン・ヒーリー（訳：瓜生真也・江口哲史・三村喬生）（2021）．『[実践Data Scienceシリーズ　データ分析のためのデータ可視化入門](https://bookclub.kodansha.co.jp/product?item=0000323306)』「講談社」．

**Rによる地理空間データの可視化**

- チュートリアル[ホーム](https://shinichiro-iwata.github.io/geospatial-data-visualization/)